---
title: "Indicator guidance for the Education in Emergencies Sector"
output: pdf_document
date: '2023-09-07'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(janitor)
library(scales)
library(viridis)
library(patchwork)
library(DT)
library(here)
library(sf)
library(plotly)
library(flextable)
library(ggrepel)
library(anytime)
library(tidytext)
library(ggsflabel)

theme_set(theme_light())
```

```{r data}
# Run this if you need to
# rmarkdown::render(input = "5Ws_cleaning_script.Rmd")

locations <- read_xlsx("./data/ken_adminboundaries_tabulardata.xlsx", 
                      sheet = "ADM2") %>% 
  clean_names()

sitrep_table <- read_xlsx("./data/sitrep_results_table.xlsx") %>% 
  clean_names()

targets <- read_csv("./data/eie_targets.csv")

pcode1_shape <- 
  sf::st_read("./data/ken_adm_iebc_20191031_shp/ken_admbnda_adm1_iebc_20191031.shp", 
          quiet = TRUE) %>% 
  clean_names()

ipc <- read_csv("./data/ipc.csv")

partner_list_counties <- read_csv("./data/partner_list_counties.csv") %>% 
  filter(partner_type == "implementing_partner")

eie <- read_csv("./data/eie_5ws.csv") %>% 
  filter(!is.na(indicator_short)) %>% 
  replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>% 
  # Total reached of indicator 1 is only boys and girls 
  mutate(total_reached = case_when(str_detect(indicator, "1") ~ boys + girls, 
                                   str_detect(indicator, "5") ~ men + women, 
                                   str_detect(indicator, "6") ~ boys + girls, 
                                   TRUE ~ total_reached))
```

# Sector Reached 

The number of persons reached by the EiE sector is the sum of beneficiaries reached by these indicators:

<br>

```{r}
eie %>% 
  count(indicator) %>% 
  filter(str_detect(indicator, "1|2|5|6")) %>% 
  mutate(indicator = str_replace_all(indicator, 
                                     "indicator", 
                                     "Indicator")) %>% 
  select(-n) %>% 
  flextable() %>% 
  theme_zebra() %>% 
  set_table_properties(layout = "autofit", width = .99)
```

<br> 

However, several conditions should be taken into account: 

> Only beneficiaries who are boys and girls are counted towards the totals for indicator 1 and indicator 6. 

> Only beneficiaries who are adults are counted towards indicator 5. 

> Boys, girls, men and women all count towards the calculation of indicator 2. 


# UNICEF reached, for sitrep

```{r}
sum_stats <- eie %>%  
  summarise(partners = n_distinct(implementing_partner), 
            counties = n_distinct(county), 
            reached = sum(sector_reached, na.rm = TRUE), 
            men = sum(men[str_detect(indicator_short, "2|5") & 
                            activity_status == "Completed"], na.rm = TRUE), 
            women = sum(women[str_detect(indicator_short, "2|5") &
                                activity_status == "Completed"], na.rm = TRUE), 
            boys = sum(boys[str_detect(indicator_short, "1|2|6") &
                              activity_status == "Completed"], na.rm = TRUE), 
            girls = sum(girls[str_detect(indicator_short, "1|2|6") & 
                                activity_status == "Completed"], na.rm = TRUE), 
            reached_1256 = sum(total_reached[str_detect(indicator_short, "1|2|5|6") & 
                                               activity_status == "Completed"], na.rm = TRUE), 
            latest_reached = sum(total_reached[str_detect(indicator_short, "1|2|5|6") & 
                                               activity_status == "Completed"& 
                                                 month %in% params$report_month], 
                                 na.rm = TRUE))



```


