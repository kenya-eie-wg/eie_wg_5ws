indicator3_refugees_total_children = indicator3_refugees_boys + indicator3_refugees_girls,
indicator3_cwd_total_children = indicator3_cwd_boys + indicator3_cwd_girls,
indicator4_host_community_total_adults = indicator4_host_community_female +
indicator4_host_community_male,
indicator4_idps_total_adults = indicator4_idps_female + indicator4_idps_male,
indicator4_refugees_total_adults = indicator4_refugees_male + indicator4_refugees_female,
indicator5_host_community_total_adults = indicator5_host_community_female +
indicator5_host_community_male,
indicator5_idps_total_adults = indicator5_idps_female + indicator5_idps_male,
indicator5_refugees_total_adults = indicator5_refugees_male + indicator5_refugees_female,
indicator7_host_community_total_children = indicator7_host_community_boys +
indicator7_host_community_girls,
indicator7_idps_total_children = indicator7_idps_boys + indicator7_idps_girls,
indicator7_refugees_total_children = indicator7_refugees_boys + indicator7_refugees_girls,
indicator7_cwd_total_children = indicator7_cwd_boys + indicator7_cwd_girls) %>%
mutate(indicator1_all_girls = indicator1_host_community_girls + indicator1_idps_girls +
indicator1_refugees_girls,
indicator1_all_boys = indicator1_host_community_boys + indicator1_idps_boys +
indicator1_refugees_boys,
indicator1_all_total_children = indicator1_all_boys + indicator1_all_girls,
indicator2_all_boys = indicator2_host_community_boys + indicator2_idps_boys +
indicator2_refugees_boys,
indicator2_all_girls = indicator2_host_community_girls + indicator2_idps_girls +
indicator2_refugees_girls,
indicator2_all_total_children = indicator2_all_boys + indicator2_all_girls,
indicator3_all_boys = indicator3_host_community_boys + indicator3_idps_boys +
indicator3_refugees_boys,
indicator3_all_girls = indicator3_host_community_girls + indicator3_idps_girls +
indicator3_refugees_girls,
indicator3_all_total_children = indicator3_all_boys + indicator3_all_girls,
indicator4_all_female = indicator4_host_community_female + indicator4_idps_female +
indicator4_refugees_female,
indicator4_all_male = indicator4_host_community_male + indicator4_idps_male +
indicator4_refugees_male,
indicator4_all_total_adults = indicator4_all_female + indicator4_all_male,
indicator5_all_female = indicator5_host_community_female + indicator5_idps_female +
indicator5_refugees_female,
indicator5_all_male = indicator5_host_community_male + indicator5_idps_male +
indicator5_refugees_male,
indicator5_all_total_adults = indicator5_all_female + indicator5_all_male,
indicator7_all_girls = indicator7_host_community_girls + indicator7_idps_girls +
indicator7_refugees_girls,
indicator7_all_boys = indicator7_host_community_boys + indicator7_idps_boys +
indicator7_refugees_boys,
indicator7_all_total_children = indicator7_all_boys + indicator7_all_girls,
indicator6_all_total_adults = indicator6_all_female + indicator6_all_male) %>%
filter(month != "Total")  %>%
group_by(county) %>%
group_modify(~bind_rows(.,
summarise(., across(where(is.numeric), sum)))) %>%
ungroup() %>%
mutate(month = ifelse(is.na(month), "Total", month)) %>%
mutate_at(vars(everything()), ~ as.character(.)) %>%
pivot_longer(cols = indicator1_all_total_children:indicator7_narrative,
names_to = "indicator",
values_to = "value") %>%
mutate(month = fct_relevel(month, c("January", "February", "March",
"April", "May", "June", "July")),
char_value = as.character(value),
value = as.numeric(value))
}
combined_july <- read_excel("./data/unicef_internal/Copy of Monthly Education SitRep_Jul23_lzo.xlsx") %>%
clean_messy_table_alt() %>%
rename(lzo_value = value,
lzo_char_value = char_value) %>%
left_join(read_excel("./data/unicef_internal/Kajiado Kwale Kilifi Monthly Education SitRep_Jul23.xlsx") %>%
clean_messy_table_alt() %>%
rename(kzo_value = value,
kzo_char_value = char_value),
by = c("month", "county", "indicator")) %>%
left_join(read_excel("./data/unicef_internal/Copy of Monthly Education SitRep_July 2023 GZO input.xlsx") %>%
clean_messy_table_alt() %>%
rename(gzo_value = value,
gzo_char_value = char_value),
by = c("month", "county", "indicator")) %>%
mutate(value = case_when(!is.na(lzo_value) & !is.na(kzo_value) & !is.na(gzo_value) ~
pmax(lzo_value, kzo_value, gzo_value),
!is.na(lzo_value) & !is.na(kzo_value) ~
pmax(lzo_value, kzo_value),
!is.na(lzo_value) & !is.na(gzo_value) ~
pmax(lzo_value, gzo_value),
!is.na(kzo_value) & !is.na(gzo_value) ~
pmax(kzo_value, gzo_value),
is.na(lzo_value) & is.na(kzo_value) ~ gzo_value,
is.na(gzo_value) & is.na(kzo_value) ~ lzo_value,
is.na(gzo_value) & is.na(lzo_value) ~ kzo_value,
TRUE ~ NA_integer_)) %>%
mutate(char_value = case_when(!is.na(lzo_char_value) ~ lzo_char_value,
!is.na(gzo_char_value) ~ gzo_char_value,
!is.na(kzo_char_value) ~ kzo_char_value,
TRUE ~ NA_character_)) %>%
rename(sub_indicator = indicator) %>%
mutate(sex_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "girls|women|Women|Girls|Female|female") ~ "female",
str_detect(sub_indicator, "boys|Boys|men|Men|Male|male") ~ "male",
str_detect(sub_indicator, "total") ~ "total",
TRUE ~ NA_character_),
beneficiary_group = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "host_community") ~ "host_community",
str_detect(sub_indicator, "idps") ~ "idps",
str_detect(sub_indicator, "refugees") ~ "refugees",
str_detect(sub_indicator, "all") ~ "all",
str_detect(sub_indicator, "cwd") ~ "cwd",
TRUE ~ NA_character_),
age_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "boys|girls|children") ~ "children",
str_detect(sub_indicator, "Male|male|Female|female|adults") ~ "adults",
str_detect(sub_indicator, "all") & str_detect(sub_indicator, "1|3|7|2") ~ "children",
str_detect(sub_indicator, "all") & str_detect(sub_indicator, "5|6|4") ~ "adults",
TRUE ~ NA_character_)) %>%
mutate(age_modifier = case_when(str_detect(sub_indicator, "1|3|7") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "children",
str_detect(sub_indicator, "4|5|6") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "adults",
str_detect(sub_indicator, "2") & !is.na(sex_modifier) ~ "children",
TRUE ~ age_modifier)) %>%
mutate(unicef_indicator_number = as.factor(parse_number(sub_indicator)),
unicef_indicator = case_when(str_detect(sub_indicator, "1") ~
"1. OOSC accessing formal education",
str_detect(sub_indicator, "2") ~
"2. Children benefiting from child-friendly environment",
str_detect(sub_indicator, "3") ~
"3. Children who receive assistance to continue learning",
str_detect(sub_indicator, "4") ~
"4. Teachers trained resilience programmes",
str_detect(sub_indicator, "5") ~
"5. BoM trained resilience programmes",
str_detect(sub_indicator, "6") ~
"6. Govt. officials trained",
str_detect(sub_indicator, "7") ~
"7. Children life skills mentorship")) %>%
select(-kzo_value, -lzo_value, -gzo_value,
-kzo_char_value, -lzo_char_value, -gzo_char_value)
combined_july
combined_july %>% filter(str_detect(sub_indicator, "2"))
combined_july %>% filter(str_detect(sub_indicator, "2") & month == "July")
combined_july %>% filter(str_detect(sub_indicator, "2") & month == "July" & value != 0)
combined <- rbind(combined_august,
combined_july %>% select(-char_value)) %>%
rename(beneficiary_type = beneficiary_group) %>%
mutate(beneficiary_type = recode(beneficiary_type,
"host_community" = "Vulnerable Residents",
"cwd" = "Persons with Disabilities",
"idps" = "IDPs",
"refugees" = "Refugees"))
# list.files("./data/unicef_internal")
clean_monthly_sitrep <- function(x) {
x %>%
select(-matches("narrative"),
-index) %>%
pivot_longer(cols = indicator1_host_community_boys:indicator7_cwd_total_children,
names_to = "sub_indicator",
values_to = "value") %>%
mutate(month = fct_relevel(month, c("January", "February", "March",
"April", "May", "June",
"July", "August", "September",
"October", "November", "December"))) %>%
mutate(unicef_indicator_number = as.factor(parse_number(sub_indicator)),
unicef_indicator = case_when(str_detect(sub_indicator, "1") ~
"1. OOSC accessing formal education",
str_detect(sub_indicator, "2") ~
"2. Children benefiting from child-friendly environment",
str_detect(sub_indicator, "3") ~
"3. Children who receive assistance to continue learning",
str_detect(sub_indicator, "4") ~
"4. Teachers trained resilience programmes",
str_detect(sub_indicator, "5") ~
"5. BoM trained resilience programmes",
str_detect(sub_indicator, "6") ~
"6. Govt. officials trained",
str_detect(sub_indicator, "7") ~
"7. Children life skills mentorship")) %>%
mutate(sex_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "girls|women|Women|Girls|Female|female") ~ "female",
str_detect(sub_indicator, "boys|Boys|men|Men|Male|male") ~ "male",
str_detect(sub_indicator, "total") ~ "total",
TRUE ~ NA_character_),
beneficiary_group = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "host_community") ~ "host_community",
str_detect(sub_indicator, "idps") ~ "idps",
str_detect(sub_indicator, "refugees") ~ "refugees",
str_detect(sub_indicator, "all") ~ "all",
str_detect(sub_indicator, "cwd") ~ "cwd",
TRUE ~ NA_character_),
age_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "boys|girls|children") ~ "children",
str_detect(sub_indicator, "Male|male|Female|female|adults") ~ "adults",
str_detect(sub_indicator, "all") &
str_detect(sub_indicator, "1|3|7|2") ~ "children",
str_detect(sub_indicator, "all") &
str_detect(sub_indicator, "5|6|4") ~ "adults",
TRUE ~ NA_character_)) %>%
mutate(age_modifier = case_when(str_detect(sub_indicator, "1|3|7") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "children",
str_detect(sub_indicator, "4|5|6") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "adults",
str_detect(sub_indicator, "2") & !is.na(sex_modifier) ~ "children",
TRUE ~ age_modifier))
}
combined_august <- read_excel("./data/unicef_internal/Copy of data_entry_monthly_sitrep August LZO.xlsx",
sheet = "data_entry") %>%
clean_monthly_sitrep() %>%
rename(lzo_value = value) %>%
left_join(read_excel("./data/unicef_internal/Data_entry_monthly_sitrepAugust sitrep_gzo.xlsx",
sheet = "data_entry") %>%
clean_monthly_sitrep() %>%
rename(gzo_value = value) %>%
select(month, county, sub_indicator, gzo_value),
by = c("month", "county", "sub_indicator")) %>%
left_join(read_excel("./data/unicef_internal/Kajiado Kwale Kilifi Data_entry_monthly_sitrepAugust sitrep.xlsx",
sheet = "data_entry") %>%
clean_monthly_sitrep() %>%
rename(kzo_value = value) %>%
select(month, county, sub_indicator, kzo_value),
by = c("month", "county", "sub_indicator")) %>%
mutate(value = pmax(gzo_value, lzo_value, kzo_value)) %>%
select(-gzo_value, -lzo_value, -kzo_value)
combined_august %>% write_csv(paste0("./data/combined_august",  format(Sys.time(), '%Y%m%d'), ".csv"))
combined <- rbind(combined_august,
combined_july %>% select(-char_value)) %>%
rename(beneficiary_type = beneficiary_group) %>%
mutate(beneficiary_type = recode(beneficiary_type,
"host_community" = "Vulnerable Residents",
"cwd" = "Persons with Disabilities",
"idps" = "IDPs",
"refugees" = "Refugees"))
combined %>% write_csv(paste0("./data/combined_july_august", format(Sys.Date(), "%Y%m%d"), ".csv"))
combined <- read_csv("./data/combined_july_august20231009.csv")
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0)
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0 &
!str_detect(sub_indicator, "all|total"))
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0 &
!str_detect(sub_indicator, "all|total")) %>%
distint(county, month, value)
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0 &
!str_detect(sub_indicator, "all|total")) %>%
distinct(county, month, value)
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all"))
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
distinct(county, month, value) %>%
summarise(girls = sum(value[sex_modifier == "female"], na.rm = TRUE),
boys = sum(value[sex_modifier == "male"], na.rm = TRUE),
total = sum(value[sex_modifier == "total"], na.rm = TRUE),
counties = n_distinct(county))
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
distinct(county, month, value)
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
distinct(county, month, sex_modifier, value)
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
distinct(county, month, sex_modifier, value) %>%
summarise(girls = sum(value[sex_modifier == "female"], na.rm = TRUE),
boys = sum(value[sex_modifier == "male"], na.rm = TRUE),
total = sum(value[sex_modifier == "total"], na.rm = TRUE),
counties = n_distinct(county))
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0 &
!str_detect(sub_indicator, "all|total")) %>%
distinct(county, month, value)
indicator6 <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0 &
!str_detect(sub_indicator, "all|total")) %>%
distinct(county, month, sex_modifier, value) %>%
summarise(girls = sum(value[sex_modifier == "female"], na.rm = TRUE),
boys = sum(value[sex_modifier == "male"], na.rm = TRUE),
total = sum(value[sex_modifier == "total"], na.rm = TRUE),
counties = n_distinct(county))
indicator6
indicator6 <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "7") & value != 0 &
!str_detect(sub_indicator, "all|total")) %>%
distinct(county, month, sex_modifier, value) %>%
summarise(girls = sum(value[sex_modifier == "female"], na.rm = TRUE),
boys = sum(value[sex_modifier == "male"], na.rm = TRUE),
counties = n_distinct(county)) %>%
mutate(total = girls + boys)
indicator6
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") &
value != 0) %>%
list_counties() %>%
%>%
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") &
value != 0) %>%
list_counties() %>%
stri_replace_last(fixed = ",", " and")
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
distinct(county, month, sex_modifier, value) %>%
summarise(girls = sum(value[sex_modifier == "female"], na.rm = TRUE),
boys = sum(value[sex_modifier == "male"], na.rm = TRUE),
counties = n_distinct(county)) %>%
mutate(total = girls + boys)
cf_environment <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
distinct(county, month, sex_modifier, value) %>%
summarise(girls = sum(value[sex_modifier == "female"], na.rm = TRUE),
boys = sum(value[sex_modifier == "male"], na.rm = TRUE),
counties = n_distinct(county)) %>%
mutate(total = girls + boys)
cf_environment %>% pull(total) %>% format(big.mark = ",")
cf_environment_counties <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "2") &
value != 0) %>%
list_counties() %>%
stri_replace_last(fixed = ",", " and")
cf_environment_counties
govt_officials <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "6") & value != 0) %>%
summarise(women = sum(value[sex_modifier == "female"], na.rm = TRUE),
men = sum(value[sex_modifier == "male"], na.rm = TRUE),
total = sum(value[sex_modifier == "total"], na.rm = TRUE),
counties = n_distinct(county))
bom <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "5") & value != 0) %>%
summarise(women = sum(value[sex_modifier == "female"], na.rm = TRUE),
men = sum(value[sex_modifier == "male"], na.rm = TRUE),
total = sum(value[sex_modifier == "total"], na.rm = TRUE)) %>%
rbind(eie %>%
replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>%
# Total reached of indicator 1 is only boys and girls
mutate(total_reached = ifelse(str_detect(indicator, "5.2"),
men + women,
total_reached)) %>%
filter(month %in% report_months & str_detect(indicator, "5.2") &
lead_organisation == "UNICEF" & activity_status == "Completed") %>%
summarise(men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
mutate_at(vars(men, women), ~ replace_na(., 0)) %>%
mutate(total = men + women)) %>%
summarise(women = sum(women),
men = sum(men),
total = sum(total))
teachers <- eie %>%
replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>%
# Total reached of indicator 1 is only boys and girls
mutate(total_reached = ifelse(str_detect(indicator, "5.1"),
men + women,
total_reached)) %>%
filter(month %in% report_months & str_detect(indicator, "5.1") &
lead_organisation == "UNICEF" & activity_status == "Completed") %>%
summarise(men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
mutate_at(vars(men, women), ~ replace_na(., 0)) %>%
mutate(total = men + women) %>%
rbind(combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "4") & value != 0) %>%
summarise(women = sum(value[sex_modifier == "female"], na.rm = TRUE),
men = sum(value[sex_modifier == "male"], na.rm = TRUE),
total = sum(value[sex_modifier == "total"], na.rm = TRUE))) %>%
summarise(women = sum(women),
men = sum(men),
total = sum(total))
govt_officials %>% pull(total) %>% format(big.mark = ",")
govt_officials %>% pull(men) %>% format(big.mark = ",")
govt_officials %>% pull(women) %>% format(big.mark = ",")
combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "4") & value != 0)
ie %>%
replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>%
# Total reached of indicator 1 is only boys and girls
mutate(total_reached = ifelse(str_detect(indicator, "5.3"),
men + women,
total_reached)) %>%
filter(month %in% report_months & str_detect(indicator, "5.3"))
eie %>%
replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>%
# Total reached of indicator 1 is only boys and girls
mutate(total_reached = ifelse(str_detect(indicator, "5.3"),
men + women,
total_reached)) %>%
filter(month %in% report_months & str_detect(indicator, "5.3"))
govt_officials <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "6") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
summarise(women = sum(value[sex_modifier == "female"], na.rm = TRUE),
men = sum(value[sex_modifier == "male"], na.rm = TRUE),
counties = n_distinct(county)) %>%
mutate(total = men + women)
bom <- combined %>%
filter(month %in% report_months & str_detect(unicef_indicator, "5") & value != 0 &
!str_detect(sub_indicator, "total|all")) %>%
summarise(women = sum(value[sex_modifier == "female"], na.rm = TRUE),
men = sum(value[sex_modifier == "male"], na.rm = TRUE)) %>%
mutate(total = men + women) %>%
rbind(eie %>%
replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>%
# Total reached of indicator 1 is only boys and girls
mutate(total_reached = ifelse(str_detect(indicator, "5.2"),
men + women,
total_reached)) %>%
filter(month %in% report_months & str_detect(indicator, "5.2") &
lead_organisation == "UNICEF" & activity_status == "Completed") %>%
summarise(men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
mutate_at(vars(men, women), ~ replace_na(., 0)) %>%
mutate(total = men + women)) %>%
summarise(women = sum(women),
men = sum(men),
total = sum(total))
bom
bom
teachers
sitrep_table_new <- eie %>%
filter(activity_status == "Completed") %>%
mutate(group = ifelse(str_detect(lead_organisation, "UNICEF"),
"unicef", "non_unicef")) %>%
filter(str_detect(indicator, "1|3")) %>%
mutate(total = boys + girls) %>%
pivot_longer(cols = c(boys, girls, total),
names_to = "sex_modifier",
values_to = "beneficiaries") %>%
mutate(sex_modifier = str_to_title(sex_modifier),
sex_modifier = fct_relevel(sex_modifier,
c("Total", "Girls", "Boys"))) %>%
group_by(indicator_short, sex_modifier) %>%
summarise(unicef_previous_results = sum(beneficiaries[month %in% previous_months & group == "unicef"],
na.rm = TRUE),
unicef_total_results = sum(beneficiaries[group == "unicef"],
na.rm = TRUE),
sector_previous_results = sum(beneficiaries[month %in% previous_months], na.rm = TRUE),
sector_total_results = sum(beneficiaries, na.rm = TRUE),
.groups = "drop") %>%
mutate(indicator_match = ifelse(indicator_short == "1. Access ECD spaces/schools",
"Access to education",
"Learning materials"),
match = paste0(indicator_match, sex_modifier)) %>%
left_join(sitrep_table %>%
mutate(indicator_match = ifelse(str_detect(indicator_match, "education"),
"Access to education",
"Learning materials"),
sex_modifier = case_when(
str_detect(sex_modifier, "Total") ~ "Total",
str_detect(sex_modifier, "Girls") ~ "Girls",
str_detect(sex_modifier, "Boys") ~ "Boys")) %>%
# You can remove this later, since you've figured out the error
mutate(match = paste0(indicator_match, sex_modifier)) %>%
mutate_at(vars(needs, unicef_target, sector_target),
~ parse_number(.)) %>%
select(match, needs, unicef_target, sector_target),
by = c("match")) %>%
mutate(unicef_progress_rate = round(unicef_total_results / unicef_target * 100, digits = 2),
sector_progress_rate = round(sector_total_results / sector_target * 100, digits = 2)) %>%
select(indicator = indicator_match, sex_modifier, needs,
unicef_target, unicef_total_results, unicef_previous_results, unicef_progress_rate,
sector_target, sector_total_results, sector_previous_results, sector_progress_rate)
sitrep_table_new
sitrep_table_new <- eie %>%
filter(activity_status == "Completed") %>%
mutate(group = ifelse(str_detect(lead_organisation, "UNICEF"),
"unicef", "non_unicef")) %>%
filter(str_detect(indicator, "1|3")) %>%
mutate(total = boys + girls) %>%
pivot_longer(cols = c(boys, girls, total),
names_to = "sex_modifier",
values_to = "beneficiaries") %>%
mutate(sex_modifier = str_to_title(sex_modifier),
sex_modifier = fct_relevel(sex_modifier,
c("Total", "Girls", "Boys"))) %>%
group_by(indicator_short, sex_modifier) %>%
summarise(unicef_previous_results = sum(beneficiaries[month %in% previous_months & group == "unicef"],
na.rm = TRUE),
unicef_total_results = sum(beneficiaries[group == "unicef"],
na.rm = TRUE),
sector_previous_results = sum(beneficiaries[month %in% previous_months], na.rm = TRUE),
sector_total_results = sum(beneficiaries, na.rm = TRUE),
.groups = "drop") %>%
mutate(indicator_match = ifelse(indicator_short == "1. Access ECD spaces/schools",
"Access to education",
"Learning materials"),
match = paste0(indicator_match, sex_modifier)) %>%
left_join(sitrep_table %>%
mutate(indicator_match = ifelse(str_detect(indicator_match, "education"),
"Access to education",
"Learning materials"),
sex_modifier = case_when(
str_detect(sex_modifier, "Total") ~ "Total",
str_detect(sex_modifier, "Girls") ~ "Girls",
str_detect(sex_modifier, "Boys") ~ "Boys")) %>%
# You can remove this later, since you've figured out the error
mutate(match = paste0(indicator_match, sex_modifier)) %>%
mutate_at(vars(needs, unicef_target, sector_target),
~ parse_number(.)) %>%
select(match, needs, unicef_target, sector_target),
by = c("match")) %>%
mutate(unicef_progress_rate = round(unicef_total_results / unicef_target * 100, digits = 2),
sector_progress_rate = round(sector_total_results / sector_target * 100, digits = 2)) %>%
select(indicator = indicator_match, sex_modifier, needs,
unicef_target, unicef_total_results, unicef_previous_results, unicef_progress_rate,
sector_target, sector_total_results, sector_previous_results, sector_progress_rate) %>%
filter(!is.na(indicator))
sitrep_table_new %>%
flextable() %>%
theme_zebra() %>%
fontsize(part = "header", size = 6) %>%
fontsize(i = 1:6, j = 1:11, size = 7)
