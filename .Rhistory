# Alternatively, follow the instructions here: https://a-benini.github.io/mdepriv/
# disabling scientific notation
options(scipen = 100)
`%out%` <- Negate(`%in%`)
# function for transposing df
transpose_df <- function(df) {
t_df <- data.table::transpose(df)
colnames(t_df) <- rownames(df)
rownames(t_df) <- colnames(df)
t_df <- t_df %>%
tibble::rownames_to_column(.data = .) %>%
tibble::as_tibble(.)
return(t_df)
}
# scaling functions
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}
# mode function
mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
# Fixing dates
name_to_date <- function(x) {
lubridate::mdy(ifelse(x %in% c(month.name, month.abb), paste0(x, "/01/2023"), x))
}
# Run this if you need to
# rmarkdown::render(input = "5Ws_cleaning_script.Rmd")
locations <- read_xlsx("./data/ken_adminboundaries_tabulardata.xlsx",
sheet = "ADM2") %>%
clean_names()
sitrep_table <- read_xlsx("./data/sitrep_results_table.xlsx") %>%
clean_names()
targets <- read_csv("./data/eie_targets.csv")
pcode1_shape <-
sf::st_read("./data/ken_adm_iebc_20191031_shp/ken_admbnda_adm1_iebc_20191031.shp",
quiet = TRUE) %>%
clean_names()
ipc <- read_csv("./data/ipc.csv")
partner_list_counties <- read_csv("./data/partner_list_counties.csv") %>%
filter(partner_type == "implementing_partner")
eie <- read_csv("./data/eie_5ws.csv") %>%
filter(!is.na(indicator_short)) %>%
replace_na(list(boys = 0, girls = 0, men = 0, women = 0)) %>%
# Total reached of indicator 1 is only boys and girls
mutate(total_reached = case_when(str_detect(indicator, "1") ~ boys + girls,
str_detect(indicator, "5") ~ men + women,
str_detect(indicator, "6") ~ boys + girls,
TRUE ~ total_reached))
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator) %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(county))
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(county))
eie %>%
filter(activity_status == "Completed") %>%
mutate(lead_organisation = str_sub(lead_organisation, end = 50L)) %>%
group_by(lead_organisation) %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(adm1_pcode),
activities = n_distinct(indicator_short)) %>%
filter(reached > 0) %>%
mutate(`%total` = round(reached / sum(reached) * 100, digits = 2)) %>%
arrange(desc(reached)) %>%
flextable() %>%
theme_zebra() %>%
set_caption("Summary by lead organisation") %>%
set_table_properties(layout = "autofit", width = .9) %>%
footnote(i = 1, j = 2, ref_symbols = "1", part = "header",
as_paragraph("All indicators as opposed only indicators 1, 2, 5 and 6")) %>%
footnote(i = 1, j = 5, ref_symbols = "2", part = "header",
as_paragraph("Percentage of reached for all indicators"))
ben_plot <- function(tbl) {
tbl %>%
group_by(indicator_short, county) %>%
summarise(beneficiaries = sum(total_reached, na.rm = TRUE)) %>%
full_join(targets %>%
filter(target_unit %in% c("people")) %>%
select(county, indicator_short, county_target),
by = c("county", "indicator_short")) %>%
replace_na(list(county_target = 0,
beneficiaries = 0)) %>%
filter(beneficiaries > 0) %>%
mutate(pc = ifelse(county_target > 0, beneficiaries / county_target, 0),
county = fct_reorder(county, beneficiaries)) %>%
ggplot(aes(x = beneficiaries, y = county)) +
geom_col(aes(fill = pc)) +
geom_text(aes(label = comma(beneficiaries), hjust = "inward"),
colour = "grey45") +
scale_x_continuous(labels = comma) +
scale_fill_viridis(direction = -1, option = "mako",
labels = percent, begin = .2) +
labs(title = "Beneficiaries reached",
x = "Beneficiaries",
y = "",
fill = "% reached")
}
tbl %>%
group_by(indicator_short, county) %>%
summarise(beneficiaries = sum(total_reached, na.rm = TRUE)) %>%
full_join(targets %>%
filter(target_unit %in% c("people")) %>%
select(county, indicator_short, county_target),
by = c("county", "indicator_short")) %>%
replace_na(list(county_target = 0,
beneficiaries = 0)) %>%
filter(beneficiaries > 0) %>%
mutate(pc = ifelse(county_target > 0, beneficiaries / county_target, 0),
county = fct_reorder(county, beneficiaries)) %>%
ggplot(aes(x = pc, y = county)) +
geom_col(aes(fill = pc)) +
geom_text(aes(label = percent(pc, accuracy = .1), hjust = "inward"),
colour = "grey45") +
scale_x_continuous(labels = percent) +
scale_fill_viridis(direction = -1, option = "mako",
labels = percent, begin = .2) +
labs(title = "% of target reached",
x = "% reached",
y = "",
fill = "% reached") +
theme(legend.position = "none")
pc_plot <- function(tbl) {
tbl %>%
group_by(indicator_short, county) %>%
summarise(beneficiaries = sum(total_reached, na.rm = TRUE)) %>%
full_join(targets %>%
filter(target_unit %in% c("people")) %>%
select(county, indicator_short, county_target),
by = c("county", "indicator_short")) %>%
replace_na(list(county_target = 0,
beneficiaries = 0)) %>%
filter(beneficiaries > 0) %>%
mutate(pc = ifelse(county_target > 0, beneficiaries / county_target, 0),
county = fct_reorder(county, beneficiaries)) %>%
ggplot(aes(x = pc, y = county)) +
geom_col(aes(fill = pc)) +
geom_text(aes(label = percent(pc, accuracy = .1), hjust = "inward"),
colour = "grey45") +
scale_x_continuous(labels = percent) +
scale_fill_viridis(direction = -1, option = "mako",
labels = percent, begin = .2) +
labs(title = "% of target reached",
x = "% reached",
y = "",
fill = "% reached") +
theme(legend.position = "none")
}
targets_range <- targets %>%
filter(target_unit == "people") %>%
group_by(indicator_short, county) %>%
summarise(target = sum(county_target, na.rm = TRUE)) %>%
pivot_wider(names_from = indicator_short, values_from = target) %>%
setNames(c("county", "indicator1", "indicator2", "indicator3", "indicator4",
"indicator5", "indicator6"))
indicator_map <- function(tbl, indicator_number, plot_option) {
plot_option <- enquo(plot_option)
indicator_number <- enquo(indicator_number)
tbl %>%
filter(str_detect(indicator_short, !!indicator_number)) %>%
group_by(indicator_short, county) %>%
summarise(beneficiaries = sum(total_reached, na.rm = TRUE)) %>%
full_join(targets %>%
filter(str_detect(indicator_short, !!indicator_number)) %>%
filter(target_unit %in% c("people")) %>%
select(county, indicator_short, county_target),
by = c("county", "indicator_short")) %>%
replace_na(list(county_target = 0,
beneficiaries = 0)) %>%
filter(beneficiaries > 0 | county_target > 0)  %>%
mutate(pc = ifelse(county_target > 0, beneficiaries / county_target, 0),
county = fct_reorder(county, beneficiaries)) %>%
naniar::replace_with_na(list(beneficiaries = 0)) %>%
left_join(locations %>%
distinct(county = adm1_en, adm1_pcode),
by = "county") %>%
right_join(pcode1_shape, by = c("adm1_pcode")) %>%
st_as_sf() %>%
ggplot() +
geom_sf(size = .01, colour = "grey70",
aes(fill = !!plot_option)) +
geom_sf_text(aes(label = comma(!!plot_option)),
colour = "grey45",
size = 2.5) +
scale_fill_viridis_c(labels = comma,
na.value = "grey80") +
theme_void() +
theme(plot.title = element_text(hjust = .5))
}
summary_table %>%
filter(str_detect(Indicator, "1")) %>%
flextable() %>%
set_caption(paste0("EiE Indicator 1, as of ", params$report_date)) %>%
set_table_properties(layout = "autofit", width = .99)
sum_stats <- eie %>%
summarise(partners = n_distinct(implementing_partner),
counties = n_distinct(county),
reached = sum(sector_reached, na.rm = TRUE),
men = sum(men[str_detect(indicator_short, "2|5") &
activity_status == "Completed"], na.rm = TRUE),
women = sum(women[str_detect(indicator_short, "2|5") &
activity_status == "Completed"], na.rm = TRUE),
boys = sum(boys[str_detect(indicator_short, "1|2|6") &
activity_status == "Completed"], na.rm = TRUE),
girls = sum(girls[str_detect(indicator_short, "1|2|6") &
activity_status == "Completed"], na.rm = TRUE),
reached_1256 = sum(total_reached[str_detect(indicator_short, "1|2|5|6") &
activity_status == "Completed"], na.rm = TRUE),
latest_reached = sum(total_reached[str_detect(indicator_short, "1|2|5|6") &
activity_status == "Completed"&
month %in% params$report_month],
na.rm = TRUE))
summary_table <- eie %>%
filter(activity_status == "Completed") %>%
mutate(latest_reached = ifelse(month %in% params$report_month, total_reached, NA_integer_)) %>%
group_by(indicator_short) %>%
summarise(partners = n_distinct(implementing_partner),
counties = n_distinct(adm1_pcode),
latest_reached = sum(latest_reached, na.rm = TRUE),
total_reached = sum(total_reached, na.rm = TRUE)) %>%
adorn_totals("row",,,, latest_reached, total_reached) %>%
mutate(partners = ifelse(indicator_short == "Total", sum_stats$partners, partners),
counties = ifelse(indicator_short == "Total", sum_stats$counties, counties),
total_reached = ifelse(indicator_short == "Total",
sum_stats$reached_1256,
total_reached),
latest_reached = ifelse(indicator_short == "Total",
sum_stats$latest_reached,
latest_reached)) %>%
left_join(targets %>%
filter(target_unit == "people") %>%
group_by(indicator_short) %>%
summarise(target = sum(county_target)),
by = "indicator_short") %>%
mutate(target = ifelse(indicator_short == "Total",
targets %>% distinct(county, county_overall_target) %>% {sum(.$county_overall_target)},
target)) %>%
mutate(pc = round(total_reached / target * 100, digits = 2)) %>%
select(indicator = indicator_short, partners, counties,
latest_reached, total_reached, target, `%target_reached` = pc) %>%
select_all(~ gsub("latest",
params$report_month, .)) %>%
select_all(~ str_to_title(.))
summary_table %>%
flextable() %>%
theme_zebra() %>%
set_caption(paste0("Summary statistics for EIE 5Ws reporting, ", params$report_date)) %>%
set_table_properties(layout = "autofit", width = .99) %>%
fontsize(i = 1:6, j = 1, size = 9) %>%
fontsize(size = 9, part = "header") %>%
footnote(i = 1, j = 2, part = "header", ref_symbols = "1",
as_paragraph("Only implementing partners")) %>%
footnote(i = 7, j = 5:6, ref_symbols = "2",
as_paragraph("Only the sum of indicators 1, 2, 5 and 6"))
summary_table %>%
filter(str_detect(Indicator, "2")) %>%
flextable() %>%
set_caption(paste0("EiE Indicator 2, as of ", params$report_date)) %>%
set_table_properties(layout = "autofit", width = .99)
indicator_map(eie, "2", county_target) +
labs(title = "Targets",
fill = "Target")  +
indicator_map(eie, "2", beneficiaries) +
scale_fill_viridis(limits = range(targets_range$indicator2),
labels = comma,
na.value = "grey80") +
labs(title = "Total reached",
fill = "Reached") +
plot_annotation(title = "2. School feeding programmes, target and reached",
subtitle = paste0("As of ", params$report_date))
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = indicator_short)) +
geom_col()
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col()
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short))
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma") +
geom_text(aes(label = comma(reached))) +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma") +
geom_text(aes(label = comma(reached)),
position = "inward") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma") +
geom_text(aes(label = comma(reached)),
hjiust = "inward") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma") +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma",
direction = -1,
begin = .2) +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma",
direction = -1,
end = .8) +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma",
direction = -1,
end = .8) +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
scale_x_continuous(labels = comma) +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma",
direction = -1,
end = .8) +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
scale_x_continuous(labels = comma) +
labs(x = paste0("Total reached as of ", report_date),
y = "",
title = "Persons reached by each EiE indicator") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma",
direction = -1,
end = .8) +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
scale_x_continuous(labels = comma) +
labs(x = paste0("Total reached as of ", params::report_date),
y = "",
title = "Persons reached by each EiE indicator") +
theme(legend.position = "none")
eie %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
ggplot(aes(x = reached, y = fct_rev(indicator_short))) +
geom_col(aes(fill = indicator_short)) +
scale_fill_viridis_d(option = "plasma",
direction = -1,
end = .8) +
geom_text(aes(label = comma(reached)),
hjust = "inward") +
scale_x_continuous(labels = comma) +
labs(x = paste0("Total reached as of ", params$report_date),
y = "",
title = "Persons reached by each EiE indicator") +
theme(legend.position = "none")
eie %>% count(unicef_indicator)
eie %>% glimpse()
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE)) %>%
adorn_totals("row")
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(adm1_pcode)) %>%
adorn_totals("row")
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(adm1_pcode)) %>%
adorn_totals("row") %>%
mutate(counties = ifelse(indicator_short == "Total", "", counties))
eie %>%
filter(lead_organisation == "UNICEF") %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(adm1_pcode))
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(reached = sum(total_reached, na.rm = TRUE),
counties = n_distinct(adm1_pcode)) %>%
adorn_totals("row") %>%
mutate(counties = ifelse(indicator_short == "Total", "14", counties))
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(boys = sum(boys, na.rm = TRUE),
girls = sum(girls, na.rm = TRUE),
men = sum(men, na.rm = TRUE),
womne = sum(women, na.rm = TRUE)) %>%
adorn_totals("row")
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(men = sum(men[str_detect(indicator_short, "2|5") &
activity_status == "Completed"], na.rm = TRUE),
women = sum(women[str_detect(indicator_short, "2|5") &
activity_status == "Completed"], na.rm = TRUE),
boys = sum(boys[str_detect(indicator_short, "1|2|6") &
activity_status == "Completed"], na.rm = TRUE),
girls = sum(girls[str_detect(indicator_short, "1|2|6") &
activity_status == "Completed"], na.rm = TRUE)) %>%
adorn_totals("row")
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(boys = sum(boys, na.rm = TRUE),
girls = sum(girls, na.rm = TRUE),
men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
adorn_totals("row")
adorn_totals("row") %>%
mutate(counties = ifelse(indicator_short == "Total", "14", counties))
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(boys = sum(boys, na.rm = TRUE),
girls = sum(girls, na.rm = TRUE),
men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
mutate(men = ifelse(indicator_short == "1. Access ECD spaces/schools", 0, men),
women = ifelse(indicator_short == "1. Access ECD spaces/schools", 0, women))
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(boys = sum(boys, na.rm = TRUE),
girls = sum(girls, na.rm = TRUE),
men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
mutate(men = ifelse(indicator_short == "1. Access ECD spaces/schools", 0, men),
women = ifelse(indicator_short == "1. Access ECD spaces/schools", 0, women)) %>%
adorn_totals("row")
eie %>%
filter(lead_organisation == "UNICEF") %>%
group_by(indicator_short) %>%
summarise(boys = sum(boys, na.rm = TRUE),
girls = sum(girls, na.rm = TRUE),
men = sum(men, na.rm = TRUE),
women = sum(women, na.rm = TRUE)) %>%
mutate(men = ifelse(indicator_short == "1. Access ECD spaces/schools", 0, men),
women = ifelse(indicator_short == "1. Access ECD spaces/schools", 0, women)) %>%
adorn_totals(c("row", "col"))
