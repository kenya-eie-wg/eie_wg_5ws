TRUE ~ county)) %>%
fill(county) %>%
filter(month %in% c("Jan", "Feb", "Mar", "Apr", "May", "Jun")) %>%
# Keeping these empty columns to align with the original format
select(-contains("x")) %>%
pivot_longer(cols = indicator1_all_total_children:indicator7_narrative,
names_to = "indicator",
values_to = "value") %>%
mutate(month = recode(month,
"Jan" = "January",
"Feb" = "February",
"Mar" = "March",
"Apr" = "April",
"May" = "May",
"Jun" = "June")) %>%
mutate(month = fct_relevel(month, c("January", "February", "March",
"April", "May", "June")),
char_value = as.character(value),
value = as.numeric(value))
#naniar::replace_with_na(replace = list(value = 0)) %>%
#filter(!is.na(value))
}
combined <- read_excel("./data/unicef_internal/Monthly Education SitRep_Jun23_mohamed.xlsx") %>%
clean_messy_table() %>%
rename(mohamed_value = value,
mohamed_char_value = char_value) %>%
left_join(read_excel("./data/unicef_internal/June  Monthly Education SitRep_Jun23 Kwale Kilifi Kajiado and Narok.xlsx") %>%
clean_messy_table() %>%
rename(beth_value = value,
beth_char_value = char_value),
by = c("month", "county", "indicator")) %>%
left_join(read_excel("./data/unicef_internal/Monthly Education SitRep_Jun2326062023_osman.xlsx") %>%
clean_messy_table() %>%
rename(osman_value = value,
osman_char_value = char_value),
by = c("month", "county", "indicator")) %>%
mutate(value = case_when(!is.na(mohamed_value) & !is.na(beth_value) & !is.na(osman_value) ~
pmax(mohamed_value, beth_value, osman_value),
!is.na(mohamed_value) & !is.na(beth_value) ~
pmax(mohamed_value, beth_value),
!is.na(mohamed_value) & !is.na(osman_value) ~
pmax(mohamed_value, osman_value),
!is.na(beth_value) & !is.na(osman_value) ~
pmax(beth_value, osman_value),
is.na(mohamed_value) & is.na(beth_value) ~ osman_value,
is.na(osman_value) & is.na(beth_value) ~ mohamed_value,
is.na(osman_value) & is.na(mohamed_value) ~ beth_value,
TRUE ~ NA_integer_)) %>%
mutate(char_value = case_when(!is.na(mohamed_char_value) ~ mohamed_char_value,
!is.na(osman_char_value) ~ osman_char_value,
!is.na(beth_char_value) ~ beth_char_value,
TRUE ~ NA_character_)) %>%
rename(sub_indicator = indicator) %>%
mutate(sex_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "girls|women|Women|Girls|Female|female") ~ "female",
str_detect(sub_indicator, "boys|Boys|men|Men|Male|male") ~ "male",
str_detect(sub_indicator, "total") ~ "total",
TRUE ~ NA_character_),
beneficiary_group = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "host_community") ~ "host_community",
str_detect(sub_indicator, "idps") ~ "idps",
str_detect(sub_indicator, "refugees") ~ "refugees",
str_detect(sub_indicator, "all") ~ "all",
str_detect(sub_indicator, "cwd") ~ "cwd",
TRUE ~ NA_character_),
age_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "boys|girls|children") ~ "children",
str_detect(sub_indicator, "Male|male|Female|female|adults") ~ "adults",
str_detect(sub_indicator, "all") & str_detect(sub_indicator, "1|3|7|2") ~ "children",
str_detect(sub_indicator, "all") & str_detect(sub_indicator, "5|6|4") ~ "adults",
TRUE ~ NA_character_)) %>%
mutate(age_modifier = case_when(str_detect(sub_indicator, "1|3|7") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "children",
str_detect(sub_indicator, "4|5|6") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "adults",
str_detect(sub_indicator, "2") & !is.na(sex_modifier) ~ "children",
TRUE ~ age_modifier)) %>%
mutate(unicef_indicator_number = as.factor(parse_number(sub_indicator)),
unicef_indicator = case_when(str_detect(sub_indicator, "1") ~
"1. OOSC accessing formal education",
str_detect(sub_indicator, "2") ~
"2. Children benefiting from child-friendly environment",
str_detect(sub_indicator, "3") ~
"3. Children who receive assistance to continue learning",
str_detect(sub_indicator, "4") ~
"4. Teachers trained resilience programmes",
str_detect(sub_indicator, "5") ~
"5. BoM trained resilience programmes",
str_detect(sub_indicator, "6") ~
"6. Govt. officials trained",
str_detect(sub_indicator, "7") ~
"7. Children life skills mentorship")) %>%
select(-mohamed_value, -beth_value, -osman_value,
-mohamed_char_value, -beth_char_value, -osman_char_value)
combined %>% write_csv("./data/combined.csv")
column_selector <- function(tbl){
tbl %>%
mutate(x1 = "", x2 = "", x3 = "", x4 = "", x5 = "", x6 = "",
county_month = paste0(county, " ", month)) %>%
mutate(county_month = ifelse(str_detect(county_month, "NA"), NA_character_, county_month)) %>%
select("county", "month", "county_month",
"indicator1_all_total_children",
"indicator1_all_boys",
"indicator1_all_girls",
"indicator1_host_community_total_children",
"indicator1_host_community_boys",
"indicator1_host_community_girls",
"indicator1_idps_total_children",
"indicator1_idps_boys",
"indicator1_idps_girls",
"indicator1_refugees_total_children",
"indicator1_refugees_boys",
"indicator1_refugees_girls",
"indicator1_cwd_total_children",
"indicator1_cwd_boys",
"indicator1_cwd_girls",
"indicator1_narrative",
"x1",
"indicator2_all_total_children",
"indicator2_all_boys",
"indicator2_all_girls",
"indicator2_host_community_total_children",
"indicator2_host_community_boys",
"indicator2_host_community_girls",
"indicator2_idps_total_children",
"indicator2_idps_boys",
"indicator2_idps_girls",
"indicator2_refugees_total_children",
"indicator2_refugees_boys",
"indicator2_refugees_girls",
"indicator2_cwd_total_children",
"indicator2_cwd_boys",
"indicator2_cwd_girls",
"indicator2_new_latrines",
"indicator2_rehabiltated_latrines",
"indicator2_new_classrooms",
"indicator2_rehabilitated_classrooms",
"indicator2_narrative",
"x2",
"indicator3_all_total_children",
"indicator3_all_boys",
"indicator3_all_girls",
"indicator3_host_community_total_children",
"indicator3_host_community_boys",
"indicator3_host_community_girls",
"indicator3_idps_total_children",
"indicator3_idps_boys",
"indicator3_idps_girls",
"indicator3_refugees_total_children",
"indicator3_refugees_boys",
"indicator3_refugees_girls",
"indicator3_cwd_total_children",
"indicator3_cwd_boys",
"indicator3_cwd_girls",
"indicator3_narrative",
"x3",
"indicator4_all_total_adults",
"indicator4_all_male",
"indicator4_all_female",
"indicator4_host_community_total_adults",
"indicator4_host_community_male",
"indicator4_host_community_female",
"indicator4_idps_total_adults",
"indicator4_idps_male",
"indicator4_idps_female",
"indicator4_refugees_total_adults",
"indicator4_refugees_male",
"indicator4_refugees_female",
"indicator4_narrative",
"x4",
"indicator5_all_total_adults",
"indicator5_all_male",
"indicator5_all_female",
"indicator5_host_community_total_adults",
"indicator5_host_community_male",
"indicator5_host_community_female",
"indicator5_idps_total_adults",
"indicator5_idps_male",
"indicator5_idps_female",
"indicator5_refugees_total_adults",
"indicator5_refugees_male",
"indicator5_refugees_female",
"indicator5_narrative",
"x5",
"indicator6_all_total_adults",
"indicator6_all_male",
"indicator6_all_female",
"indicator6_narrative",
"x6",
"indicator7_all_total_children",
"indicator7_all_boys",
"indicator7_all_girls",
"indicator7_host_community_total_children",
"indicator7_host_community_boys",
"indicator7_host_community_girls",
"indicator7_idps_total_children",
"indicator7_idps_boys",
"indicator7_idps_girls",
"indicator7_refugees_total_children",
"indicator7_refugees_boys",
"indicator7_refugees_girls",
"indicator7_cwd_total_children",
"indicator7_cwd_boys",
"indicator7_cwd_girls",
"indicator7_narrative")
}
bottom <- crossing(combined %>% distinct(county),
combined %>% distinct(month),
messy) %>%
rename(sub_indicator = messy) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
mutate(char_value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, NA_character_)) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
pivot_wider(names_from = sub_indicator,
values_from = value) %>%
mutate_at(vars(!matches("narrative|county|month")),
~ as.numeric(.)) %>%
arrange(county) %>%
group_by(county) %>%
nest() %>%
mutate(data = map(data, ~ .x %>% adorn_totals("row", name = "Total")),
data = map(data, ~ .x %>% bind_rows(set_names(rep(NA, ncol(.)), colnames(.))))) %>%
unnest(cols = c(data)) %>%
ungroup() %>%
mutate(month = fct_relevel(month, c("Total", "January", "February", "March",
"April", "May", "June")),
county = fct_relevel(county, c(combined %>% distinct(county) %>% pull(county)))) %>%
arrange(county, month) %>%
column_selector() %>%
select(-county, -month)
bottom %>%  write_csv("./data/bottom_table.csv")
top <- crossing(combined %>% distinct(county),
combined %>% distinct(month),
messy) %>%
rename(sub_indicator = messy) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
mutate(char_value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, NA_character_)) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
pivot_wider(names_from = sub_indicator,
values_from = value) %>%
mutate_at(vars(!matches("narrative|county|month")),
~ as.numeric(.)) %>%
group_by(month) %>%
summarise_at(vars(!matches("narrative|county|month")), ~ sum(., na.rm = TRUE)) %>%
mutate(indicator1_narrative = "",
indicator2_narrative = "",
indicator3_narrative = "",
indicator4_narrative = "",
indicator5_narrative = "",
indicator6_narrative = "",
indicator7_narrative = "",
county = "Total") %>%
column_selector() %>%
select(-county, -month)
top %>% write_csv("./data/top_table.csv")
full_months <- c("January", "February", "March",
"April", "May", "June",
"July", "August", "September",
"October", "November", "December")
crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
pivot_wider(names_from = sub_indicator,
values_from = value) %>%
mutate_at(vars(!matches("narrative|county|month")),
~ as.numeric(.)) %>%
mutate(indicator1_narrative = "",
indicator2_narrative = "",
indicator3_narrative = "",
indicator4_narrative = "",
indicator5_narrative = "",
indicator6_narrative = "",
indicator7_narrative = "") %>%
column_selector() %>%
select(!matches("x"), -county_month) %>%
mutate(month = fct_relevel(month, full_months)) %>%
arrange(county, month) %>%
write_csv("./data/data_entry.csv")
data_entry_full <- crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
pivot_wider(names_from = sub_indicator,
values_from = value) %>%
mutate_at(vars(!matches("narrative|county|month")),
~ as.numeric(.)) %>%
mutate(indicator1_narrative = "",
indicator2_narrative = "",
indicator3_narrative = "",
indicator4_narrative = "",
indicator5_narrative = "",
indicator6_narrative = "",
indicator7_narrative = "") %>%
column_selector() %>%
select(!matches("x"), -county_month) %>%
mutate(month = fct_relevel(month, full_months)) %>%
arrange(county, month) %>%
write_csv("./data/data_entry.csv")
data_entry_full <- crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
pivot_wider(names_from = sub_indicator,
values_from = value) %>%
mutate_at(vars(!matches("narrative|county|month")),
~ as.numeric(.)) %>%
mutate(indicator1_narrative = "",
indicator2_narrative = "",
indicator3_narrative = "",
indicator4_narrative = "",
indicator5_narrative = "",
indicator6_narrative = "",
indicator7_narrative = "") %>%
column_selector() %>%
select(!matches("x"), -county_month) %>%
mutate(month = fct_relevel(month, full_months)) %>%
arrange(county, month)
data_entry_full %>%
write_csv("./data/data_entry.csv")
data_entry_full %>%
distinct(unicef_indicator, sub_indicator, sex_modifier, age_modifier, beneficiary_group)
data_entry_full <- crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
pivot_wider(names_from = sub_indicator,
values_from = value) %>%
mutate_at(vars(!matches("narrative|county|month")),
~ as.numeric(.)) %>%
mutate(indicator1_narrative = "",
indicator2_narrative = "",
indicator3_narrative = "",
indicator4_narrative = "",
indicator5_narrative = "",
indicator6_narrative = "",
indicator7_narrative = "") %>%
column_selector() %>%
select(!matches("x"), -county_month) %>%
mutate(month = fct_relevel(month, full_months)) %>%
arrange(county, month)
data_entry_full %>%
distinct(unicef_indicator, sub_indicator, sex_modifier, age_modifier, beneficiary_group)
data_entry_full
crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value) %>%
distinct(unicef_indicator, sub_indicator, sex_modifier, age_modifier, beneficiary_group)
crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(value = ifelse(str_detect(sub_indicator, "narrative"),
char_value, value)) %>%
select(-key, -char_value)
data_entry_long <- crossing(combined %>% distinct(county),
full_months,
messy) %>%
rename(sub_indicator = messy,
month = full_months) %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
left_join(combined %>%
mutate(key = paste0(county, month, sub_indicator)) %>%
select(key, value, comments = char_value),
by = "key") %>%
filter(!str_detect(sub_indicator, "x|month")) %>%
replace_na(list(value = 0)) %>%
mutate(comments = ifelse(str_detect(sub_indicator, "narrative"), comments, "")) %>%
select(-key) %>%
mutate(sex_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "girls|women|Women|Girls|Female|female") ~ "female",
str_detect(sub_indicator, "boys|Boys|men|Men|Male|male") ~ "male",
str_detect(sub_indicator, "total") ~ "total",
TRUE ~ NA_character_),
beneficiary_group = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "host_community") ~ "host_community",
str_detect(sub_indicator, "idps") ~ "idps",
str_detect(sub_indicator, "refugees") ~ "refugees",
str_detect(sub_indicator, "all") ~ "all",
str_detect(sub_indicator, "cwd") ~ "cwd",
TRUE ~ NA_character_),
age_modifier = case_when(str_detect(sub_indicator, "narrative") ~ NA_character_,
str_detect(sub_indicator, "boys|girls|children") ~ "children",
str_detect(sub_indicator, "Male|male|Female|female|adults") ~ "adults",
str_detect(sub_indicator, "all") & str_detect(sub_indicator, "1|3|7|2") ~ "children",
str_detect(sub_indicator, "all") & str_detect(sub_indicator, "5|6|4") ~ "adults",
TRUE ~ NA_character_)) %>%
mutate(age_modifier = case_when(str_detect(sub_indicator, "1|3|7") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "children",
str_detect(sub_indicator, "4|5|6") & is.na(age_modifier) &
!str_detect(sub_indicator, "narrative") ~ "adults",
str_detect(sub_indicator, "2") & !is.na(sex_modifier) ~ "children",
TRUE ~ age_modifier)) %>%
mutate(month = fct_relevel(month, full_months)) %>%
arrange(month, county) %>%
select(county, sub_indicator, month, sex_modifier, age_modifier, beneficiary_group, value, comments)
data_entry_long
data_entry_long %>%
left_join(combined %>%
distinct(sub_indicator, unicef_indicator),
by = "sub_indicator") %>%
distinct(unicef_indicator, sub_indicator, sex_modifier, age_modifier, beneficiary_group)
data_entry_long %>%
left_join(combined %>%
distinct(sub_indicator, unicef_indicator),
by = "sub_indicator") %>%
distinct(unicef_indicator, sub_indicator, sex_modifier, age_modifier, beneficiary_group) %>% view()
combined %>%
filter(month %in% report_month & str_detect(unicef_indicator, "6"))
combined %>%
filter(month %in% report_month & str_detect(unicef_indicator, "6") & sub_indicator == "indicator6_all_total_adults")
combined %>%
filter(month %in% report_month & str_detect(unicef_indicator, "6") &
str_detect(sub_indicator, "all"))
combined %>%
filter(month %in% report_month & str_detect(unicef_indicator, "6") &
str_detect(sub_indicator, "all")) %>%
replace_na(list(value = 0)) %>%
group_by(sex_modifier) %>%
summarise(value = sum(value))
bom_indicator <- combined %>%
filter(month %in% report_month & str_detect(unicef_indicator, "6") &
str_detect(sub_indicator, "all")) %>%
replace_na(list(value = 0)) %>%
group_by(sex_modifier) %>%
summarise(value = sum(value))
bom_indicator
bom_indicator %>% filter(sex_modifier == "male") %>% pull(value)
bom_indicator %>% filter(sex_modifier == "total") %>% pull(value)
bom_indicator %>% filter(sex_modifier == "total") %>% pull(value)
